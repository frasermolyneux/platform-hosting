# Copilot Instructions

- Purpose: Terraform-only repo that provisions shared Azure App Service plans for platform workloads; no application code here.
- Layout: all infrastructure lives under [terraform/](terraform/) with provider/backends in [terraform/providers.tf](terraform/providers.tf) and [terraform/remote_state.tf](terraform/remote_state.tf), inputs in [terraform/variables.tf](terraform/variables.tf), naming/tag logic in [terraform/locals.tf](terraform/locals.tf), and the plan resource in [terraform/app_service_plan.tf](terraform/app_service_plan.tf).
- Remote state dependency: pulls resource group metadata from the platform-workloads state via `data.terraform_remote_state.platform_workloads`; `platform_workloads_state` object input must point at that storage account/container/key and uses OIDC (`use_oidc = true`).
- Plan shaping: `app_service_plans` is a map of plans keyed by purpose (e.g., apps, workers) with `sku`, `os_type`, and optional `location`. Locals lower-case locations, pick a primary/fallback from the remote state, and build names as `asp-{workload}-{environment}-{location}-{key}`. Resource groups are selected by matching the plan/location key to the remote state map; if the requested location is missing, the first available location is used.
- Providers & requirements: Terraform >= 1.14.3; `azurerm` ~> 4.58 with `storage_use_azuread = true` and deletion protection disabled on resource groups; `azuread` ~> 3.7; backend is azurerm.
- Inputs to set per workspace/backend: `environment`, `workload_name` (defaults `platform-hosting`), `location` default `uksouth`, `subscription_id`, `platform_workloads_state` object, optional `tags`, and the `app_service_plans` map. Outputs are minimal (resource groups from remote state only).
- Local validation commands (from docs): `terraform -chdir=terraform init -backend-config=backends/dev.backend.hcl` then `terraform -chdir=terraform plan -var-file=tfvars/dev.tfvars`.
- GitHub Actions workflows: feature branches trigger `build-and-test` (Dev plan). PRs run `pr-verify` (Dev plan; add `run-prd-plan` label for Prd plan). `deploy-dev` is manual plan/apply for Dev. `deploy-prd` (push to main, weekly schedule, or manual) runs Dev apply then Prd apply with concurrency guards. Destroy workflows (`destroy-development.yml`, `destroy-environment.yml`) are available for teardown. All workflows rely on environment OIDC vars `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_SUBSCRIPTION_ID`.
- Docs: [docs/development-workflows.md](docs/development-workflows.md) documents branch triggers, labels, concurrency groups, and quick-reference tables.
- Conventions: keep everything lower-case for names/locations, tag resources via `tags` + default `Environment`/`Workload`, and prefer adding new plan variants via the `app_service_plans` map instead of duplicating resources.
